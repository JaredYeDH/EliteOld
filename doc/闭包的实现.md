闭包的实现
============

闭包是函数语言的重要特性，一般依赖对象模型实现，当然我觉得不依赖更好

## 函数是闭包的特殊形式

C语言里函数是不能临时定义的，传递也只能通过函数指针，所以不存在闭包的概念，而现在要制作一个闭包，则较为复杂。闭包是包含外部变量的函数，这个函数引用了父函数中的部分临时变量，并将其作为自己函数的一部分，储存了起来，这样，C函数其实是一种特殊的，不包含任何外部变量捕获的闭包。

## 如何在C语言下构造闭包

闭包可以是一个仿函数，利用对象来模拟，首先，这个闭包可以是一个结构体：

```
	struct run_closure{
		void (*fp)(run_closure* t, void); // 第一个参数是函数指针
		// 下面是闭包捕获变量
		...
	}
	void run(run_closure* t, void) {
		... // code
	}
```

创建时,可以这样创建:

```
	run_closure* func = new run_closure();
	func.fp = run;
	func.some = some;
	func.xxx = xxx;
```

调用时,发现是一个闭包类型,则调用其中的函数指针即可

不依赖对象模型的主要目的是将对象和闭包特性分离开,让用户可以单独选择,使用或不使用闭包类型,如果不使用,则丧失定义局部函数和捕获变量的能力,这点不会影响对象系统的其他行为
